{% extends 'reservas/base.html' %}

{% block title %}{% if reserva %}Editar{% else %}Nueva{% endif %} Reserva - Sistema de Reservas{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">
            {% if reserva %}
                ‚úèÔ∏è Editar Reserva #{{ reserva.id }}
            {% else %}
                ‚ûï Crear Nueva Reserva
            {% endif %}
        </h2>
    </div>
    
    <form method="post">
        {% csrf_token %}
        
        {% if not reserva %}
        <div class="form-group">
            <label for="cliente" class="form-label">Cliente *</label>
            <select id="cliente" name="cliente" class="form-select" required>
                <option value="">Seleccionar cliente...</option>
                {% for cliente in clientes %}
                <option value="{{ cliente.id }}">
                    {{ cliente.nombre }} {{ cliente.apellido }} - DNI: {{ cliente.dni }}
                </option>
                {% endfor %}
            </select>
            {% if not clientes %}
            <p class="text-muted mt-1" style="font-size: 0.875rem;">
                ‚ö†Ô∏è No hay clientes disponibles. <a href="{% url 'cliente_crear' %}">Crear un cliente</a>
            </p>
            {% endif %}
        </div>
        
        <div class="form-group">
            <label for="cancha" class="form-label">Cancha *</label>
            <select id="cancha" name="cancha" class="form-select" required>
                <option value="">Seleccionar cancha...</option>
                {% for cancha in canchas %}
                <option value="{{ cancha.id }}">
                    {{ cancha.nombre }} - ${{ cancha.precio_por_hora }}/hora
                </option>
                {% endfor %}
            </select>
            {% if not canchas %}
            <p class="text-muted mt-1" style="font-size: 0.875rem;">
                ‚ö†Ô∏è No hay canchas disponibles. <a href="{% url 'cancha_crear' %}">Crear una cancha</a>
            </p>
            {% endif %}
        </div>
        
        <div class="form-group">
            <label for="fecha_hora_inicio" class="form-label">Fecha y Hora de Inicio *</label>
            <input type="datetime-local" id="fecha_hora_inicio" name="fecha_hora_inicio" 
                   class="form-control" required>
        </div>
        
        <div class="form-group">
            <label for="fecha_hora_fin" class="form-label">Fecha y Hora de Fin *</label>
            <input type="datetime-local" id="fecha_hora_fin" name="fecha_hora_fin" 
                   class="form-control" required>
        </div>
        
        <div class="form-group">
            <label for="estado" class="form-label">Estado *</label>
            <select id="estado" name="estado" class="form-select" required>
                {% for codigo, nombre in estados %}
                <option value="{{ codigo }}" {% if not reserva and codigo == 'PENDIENTE' %}selected{% endif %}>
                    {{ nombre }}
                </option>
                {% endfor %}
            </select>
        </div>
        {% else %}
        <!-- Mostrar informaci√≥n de la reserva existente -->
        <div style="background-color: #f3f4f6; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem;">
            <p><strong>Cliente:</strong> {{ reserva.cliente.nombre }} {{ reserva.cliente.apellido }}</p>
            <p><strong>Cancha:</strong> {{ reserva.cancha.nombre }}</p>
            <p><strong>Horario:</strong> {{ reserva.fecha_hora_inicio|date:"d/m/Y H:i" }} - {{ reserva.fecha_hora_fin|date:"d/m/Y H:i" }}</p>
        </div>
        
        <div class="form-group">
            <label for="estado" class="form-label">Estado *</label>
            <select id="estado" name="estado" class="form-select" required>
                {% for codigo, nombre in estados %}
                <option value="{{ codigo }}" {% if reserva.estado == codigo %}selected{% endif %}>
                    {{ nombre }}
                </option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
        
        <div class="form-group">
            <label class="form-label">Servicios Adicionales (Opcional)</label>
            {% if servicios %}
            <div style="background-color: #f3f4f6; padding: 1rem; border-radius: 6px;">
                {% for servicio in servicios %}
                <div style="margin-bottom: 0.5rem;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" name="servicios" value="{{ servicio.id }}"
                               {% if reserva and servicio in reserva.servicios.all %}checked{% endif %}
                               style="margin-right: 0.5rem; width: 18px; height: 18px;">
                        <span>{{ servicio.nombre }} - ${{ servicio.costo_adicional }}</span>
                    </label>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-muted" style="font-size: 0.875rem;">
                No hay servicios adicionales disponibles.
            </p>
            {% endif %}
        </div>
        
        <div class="form-group">
            <label for="torneo" class="form-label">Torneo (Opcional)</label>
            <select id="torneo" name="torneo" class="form-select">
                <option value="">Ninguno</option>
                {% for torneo in torneos %}
                <option value="{{ torneo.id }}"
                        {% if reserva and reserva.torneo and reserva.torneo.id == torneo.id %}selected{% endif %}>
                    {{ torneo.nombre }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">
                {% if reserva %}üíæ Guardar Cambios{% else %}‚ûï Crear Reserva{% endif %}
            </button>
            <a href="{% url 'reserva_lista' %}" class="btn btn-secondary">‚ùå Cancelar</a>
        </div>
    </form>
</div>

{% if not reserva %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">‚ÑπÔ∏è Informaci√≥n Importante</h3>
    </div>
    <ul style="line-height: 2;">
        <li>El sistema validar√° autom√°ticamente la disponibilidad de la cancha.</li>
        <li>No se podr√°n crear reservas en horarios ya ocupados.</li>
        <li>El monto total se calcular√° en base al tiempo y servicios seleccionados.</li>
        <li>Se crear√° autom√°ticamente un registro de pago asociado a la reserva.</li>
    </ul>
</div>
{% endif %}
{% endblock %}
