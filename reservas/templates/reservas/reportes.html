{% extends 'reservas/base.html' %}

{% block title %}Reportes y Estadísticas - Sistema de Reservas{% endblock %}

{% block content %}
<!-- Encabezado -->
 <div class="card bg-base-100 shadow-xl">
    <div class="card-body">
<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 ">
    <h2 class="text-3xl font-bold flex items-center gap-2">
        Reportes y Estadísticas
    </h2>
    <a href="{% url 'reportes_pdf' %}?mes={{ mes_seleccionado }}&anio={{ anio_seleccionado }}" class="btn btn-success gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        Descargar PDF
    </a>
</div>
</div>
</div>
<!-- Filtros -->
<div class="card bg-base-100 shadow-xl mb-6 mt-6">
    <div class="card-body">
        <h3 class="card-title text-xl mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
            </svg>
            Filtros
        </h3>
        <form method="get" class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="form-control">
                <label class="label">
                    <span class="label-text font-semibold">Mes</span>
                </label>
                <select name="mes" class="select select-bordered w-full">
                    {% for num, nombre in meses %}
                    <option value="{{ num }}" {% if num == mes_seleccionado %}selected{% endif %}>{{ nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-control">
                <label class="label">
                    <span class="label-text font-semibold">Año</span>
                </label>
                <select name="anio" class="select select-bordered w-full">
                    {% for anio in anios %}
                    <option value="{{ anio }}" {% if anio == anio_seleccionado %}selected{% endif %}>{{ anio }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-control">
                <label class="label">
                    <span class="label-text font-semibold">Cliente (opcional)</span>
                </label>
                <select name="cliente" class="select select-bordered w-full">
                    <option value="">Todos los clientes</option>
                    {% for cliente in clientes %}
                    <option value="{{ cliente.id }}" {% if cliente_seleccionado == cliente.id|stringformat:"s" %}selected{% endif %}>
                        {{ cliente.nombre }} {{ cliente.apellido }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-control">
                <label class="label">
                    <span class="label-text font-semibold">Cancha (opcional)</span>
                </label>
                <select name="cancha" class="select select-bordered w-full">
                    <option value="">Todas las canchas</option>
                    {% for cancha in canchas %}
                    <option value="{{ cancha.id }}" {% if cancha_seleccionada == cancha.id|stringformat:"s" %}selected{% endif %}>
                        {{ cancha.nombre }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="md:col-span-4">
                <button type="submit" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    Aplicar Filtros
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Sistema de Pestañas para Reportes -->
<div class="card bg-base-100 shadow-xl">
    <div class="card-body">
        <!-- Pestañas -->
        <div role="tablist" class="tabs tabs-boxed bg-base-200 p-2 mb-6">
            <a role="tab" class="tab tab-active" data-tab="reporte1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                Clientes
            </a>
            <a role="tab" class="tab" data-tab="reporte2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                </svg>
                Canchas
            </a>
            <a role="tab" class="tab" data-tab="reporte3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                </svg>
                Ranking
            </a>
            <a role="tab" class="tab" data-tab="reporte4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                Estadísticas
            </a>
        </div>

        <!-- REPORTE 1: Clientes -->
        <div id="reporte1" class="tab-content" style="display: block;">
            <h3 class="text-2xl font-bold mb-4 flex items-center gap-2">
                <span class="badge badge-primary badge-lg">1</span>
                Listado de Reservas por Cliente
                <span class="badge badge-info">{{ clientes_con_reservas|length }} clientes</span>
            </h3>
            
            {% if clientes_con_reservas %}
            <!-- Grid: Gráfico + Tabla -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Gráfico de Barras Horizontales - Top 10 Clientes -->
                <div class="bg-white p-6 rounded-lg border-2 border-gray-200">
                    <div id="chartTopClientes"></div>
                </div>
                
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="stat bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg">
                        <div class="stat-title">Total Clientes</div>
                        <div class="stat-value text-primary">{{ clientes_con_reservas|length }}</div>
                        <div class="stat-desc text-gray-700 font-semibold">con reservas en el período</div>
                    </div>
                    <div class="stat bg-gradient-to-br from-green-50 to-green-100 rounded-lg">
                        <div class="stat-title">Mayor Gasto</div>
                        <div class="stat-value text-success">
                            {% if clientes_con_reservas %}
                                ${{ clientes_con_reservas.0.total_gasto|floatformat:0 }}
                            {% else %}
                                $0
                            {% endif %}
                        </div>
                        <div class="stat-desc text-gray-700 font-semibold">del cliente con más gasto</div>
                    </div>
                </div>
            </div>
            
            <!-- Tabla Colapsable -->
        <div class="space-y-4">
            {% for item in clientes_con_reservas %}
            <div class="collapse collapse-arrow bg-base-200">
                <input type="checkbox" class="peer" /> 
                <div class="collapse-title text-xl font-medium">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="avatar placeholder">
                                <div class="bg-primary text-primary-content rounded-full w-12">
                                    <span>{{ item.cliente.nombre.0 }}{{ item.cliente.apellido.0 }}</span>
                                </div>
                            </div>
                            <div>
                                <div class="font-bold">{{ item.cliente.nombre }} {{ item.cliente.apellido }}</div>
                                <div class="text-sm opacity-70">DNI: {{ item.cliente.dni }}</div>
                            </div>
                        </div>
                        <div class="flex gap-4 items-center">
                            <div class="badge badge-primary badge-lg">{{ item.num_reservas }} reserva{{ item.num_reservas|pluralize }}</div>
                            <div class="text-success text-lg font-bold">${{ item.total_gasto|floatformat:2 }}</div>
                        </div>
                    </div>
                </div>
                <div class="collapse-content"> 
                    <div class="divider"></div>
                    <div class="overflow-x-auto">
                        <table class="table table-zebra w-full">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Horario</th>
                                    <th>Cancha</th>
                                    <th>Estado</th>
                                    <th>Costo</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for reserva in item.reservas %}
                                <tr>
                                    <td>{{ reserva.fecha_hora_inicio|date:"d/m/Y" }}</td>
                                    <td>{{ reserva.fecha_hora_inicio|date:"H:i" }} - {{ reserva.fecha_hora_fin|date:"H:i" }}</td>
                                    <td>{{ reserva.cancha.nombre }}</td>
                                    <td>
                                        {% if reserva.estado == 'PAGADA' %}
                                        <span class="badge badge-success">{{ reserva.estado }}</span>
                                        {% elif reserva.estado == 'PENDIENTE' %}
                                        <span class="badge badge-warning">{{ reserva.estado }}</span>
                                        {% else %}
                                        <span class="badge badge-error">{{ reserva.estado }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="font-bold text-success">${{ reserva.calcular_costo_total|floatformat:2 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endfor %}
            </div>
        {% else %}
        <div class="alert alert-info">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span>No hay reservas de clientes para el período seleccionado.</span>
        </div>
        {% endif %}
        </div>

        <!-- REPORTE 2: Canchas -->
        <div id="reporte2" class="tab-content" style="display: none;">
            <h3 class="text-2xl font-bold mb-4 flex items-center gap-2">
                <span class="badge badge-primary badge-lg">2</span>
                Reservas por Cancha en el Período
                <span class="badge badge-info">{{ canchas_con_reservas|length }} canchas</span>
            </h3>
            
            {% if canchas_con_reservas %}
            <!-- Grid: Gráfico + Stats -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Gráfico de Dona - Distribución de Ingresos -->
                <div class="bg-white p-6 rounded-lg border-2 border-gray-200">
                    <div id="chartDistribucionCanchas"></div>
                </div>
                
                <!-- Stats Cards -->
                <div class="space-y-4">
                    <div class="stat bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg">
                        <div class="stat-title">Cancha Top</div>
                        <div class="stat-value text-primary text-lg">{{ canchas_con_reservas.0.cancha.nombre }}</div>
                        <div class="stat-desc text-gray-700 font-semibold">${{ canchas_con_reservas.0.total_ingresos|floatformat:0 }} en ingresos</div>
                    </div>
                    <div class="stat bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg">
                        <div class="stat-title">Total Horas Jugadas</div>
                        <div class="stat-value text-warning">
                            {% widthratio canchas_con_reservas|length 1 1 as total %}
                            {{ canchas_con_reservas.0.total_horas|floatformat:1 }}h
                        </div>
                        <div class="stat-desc text-gray-700 font-semibold">de la cancha más utilizada</div>
                    </div>
                </div>
            </div>
            
            <!-- Tabla Colapsable -->
        <div class="space-y-4">
            {% for item in canchas_con_reservas %}
            <div class="collapse collapse-arrow bg-base-200">
                <input type="checkbox" class="peer" /> 
                <div class="collapse-title text-xl font-medium">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                            </svg>
                            <div>
                                <div class="font-bold">{{ item.cancha.nombre }}</div>
                                <div class="text-sm opacity-70">{{ item.cancha.tipo.nombre }}</div>
                            </div>
                        </div>
                        <div class="flex gap-4 items-center">
                            <div class="badge badge-secondary badge-lg">{{ item.total_horas|floatformat:1 }} hs</div>
                            <div class="text-success text-lg font-bold">${{ item.total_ingresos|floatformat:2 }}</div>
                        </div>
                    </div>
                </div>
                <div class="collapse-content"> 
                    <div class="divider"></div>
                    <div class="overflow-x-auto">
                        <table class="table table-zebra w-full">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Horario</th>
                                    <th>Cliente</th>
                                    <th>Estado</th>
                                    <th>Duración</th>
                                    <th>Ingreso</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for reserva in item.reservas %}
                                <tr>
                                    <td>{{ reserva.fecha_hora_inicio|date:"d/m/Y" }}</td>
                                    <td>{{ reserva.fecha_hora_inicio|date:"H:i" }} - {{ reserva.fecha_hora_fin|date:"H:i" }}</td>
                                    <td>{{ reserva.cliente.nombre }} {{ reserva.cliente.apellido }}</td>
                                    <td>
                                        {% if reserva.estado == 'PAGADA' %}
                                        <span class="badge badge-success">{{ reserva.estado }}</span>
                                        {% elif reserva.estado == 'PENDIENTE' %}
                                        <span class="badge badge-warning">{{ reserva.estado }}</span>
                                        {% else %}
                                        <span class="badge badge-error">{{ reserva.estado }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ reserva.duracion_horas|floatformat:1 }} hs</td>
                                    <td class="font-bold text-success">${{ reserva.calcular_costo_total|floatformat:2 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endfor %}
            </div>
        {% else %}
        <div class="alert alert-info">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span>No hay reservas para canchas en el período seleccionado.</span>
        </div>
        {% endif %}
        </div>

        <!-- REPORTE 3: Ranking -->
        <div id="reporte3" class="tab-content" style="display: none;">
            <h3 class="text-2xl font-bold mb-4 flex items-center gap-2">
                <span class="badge badge-primary badge-lg">3</span>
                Ranking: Canchas Más Utilizadas
                <span class="badge badge-warning">Top {{ canchas_ranking|length }}</span>
            </h3>
            
            {% if canchas_ranking %}
            <!-- Grid: Gráfico + Tabla -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Gráfico de Barras - Ranking -->
                <div class="bg-white p-6 rounded-lg border-2 border-gray-200">
                    <div id="chartRankingCanchas"></div>
                </div>
                
                <!-- Tabla de Ranking -->
        <div class="overflow-x-auto">
            <table class="table table-zebra w-full">
                <thead>
                    <tr>
                        <th class="bg-gray-100 text-primary">Posición</th>
                        <th class="bg-gray-100 text-primary">Cancha</th>
                        <th class="bg-gray-100 text-primary">Tipo</th>
                        <th class="bg-gray-100 text-primary">Reservas</th>
                        <th class="bg-gray-100 text-primary">Total Horas</th>
                        <th class="bg-gray-100 text-primary">Ingresos</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in canchas_ranking %}
                    <tr class="hover">
                        <td>
                            {% if forloop.counter == 1 %}
                            <div class="badge badge-warning badge-lg">1°</div>
                            {% elif forloop.counter == 2 %}
                            <div class="badge badge-ghost badge-lg">2°</div>
                            {% elif forloop.counter == 3 %}
                            <div class="badge badge-ghost badge-lg">3°</div>
                            {% else %}
                            <div class="badge badge-ghost badge-lg">{{ forloop.counter }}°</div>
                            {% endif %}
                        </td>
                        <td>
                            <div class="flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-success" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                </svg>
                                <span class="font-semibold">{{ item.cancha.nombre }}</span>
                            </div>
                        </td>
                        <td><span class="badge badge-ghost">{{ item.cancha.tipo.nombre }}</span></td>
                        <td><div class="badge badge-primary badge-lg">{{ item.num_reservas }}</div></td>
                        <td>
                            <div class="flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span class="font-bold">{{ item.total_horas|floatformat:1 }} horas</span>
                            </div>
                        </td>
                        <td class="text-success text-lg font-bold">${{ item.total_ingresos|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
            </div>
        {% else %}
        <div class="alert alert-info">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span>No hay datos suficientes para generar el ranking.</span>
        </div>
        {% endif %}
        </div>

        <!-- REPORTE 4: Estadísticas -->
        <div id="reporte4" class="tab-content" style="display: none;">
            <h3 class="text-2xl font-bold mb-4 flex items-center gap-2">
                <span class="badge badge-primary badge-lg">4</span>
                Estadísticas: Utilización Mensual de Canchas (últimos 6 meses)
            </h3>
            
            {% if meses_data %}
            <div class="space-y-6">
            <!-- Gráfico de Barras -->
            <div class="bg-white p-6 rounded-lg border-2 border-gray-200">
                <div id="chartReservasMensuales"></div>
            </div>
            
            <!-- Gráfico de Línea - Horas Utilizadas -->
            <div class="bg-white p-6 rounded-lg border-2 border-gray-200">
                <div id="chartHorasMensuales"></div>
            </div>
            
            <!-- Tabla de datos -->
            <div class="overflow-x-auto">
                <table class="table table-zebra w-full">
                    <thead>
                        <tr>
                            <th class="bg-gray-100 text-primary">Mes</th>
                            <th class="bg-gray-100 text-primary">Año</th>
                            <th class="bg-gray-100 text-primary">Total Reservas</th>
                            <th class="bg-gray-100 text-primary">Total Horas</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for mes_item in meses_data %}
                        <tr class="hover">
                            <td class="font-semibold">{{ mes_item.mes }}</td>
                            <td>{{ mes_item.anio }}</td>
                            <td>
                                <div class="badge badge-primary badge-lg">{{ mes_item.total_reservas }}</div>
                            </td>
                            <td>
                                <div class="flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <span class="font-bold">{{ mes_item.total_horas|floatformat:1 }} horas</span>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
            </div>
        {% else %}
        <div class="alert alert-info">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span>No hay datos históricos disponibles.</span>
        </div>
        {% endif %}
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<style>
.tab-content {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.tab {
    transition: all 0.2s ease;
}

.tab-active {
    background-color: #84cc16 !important;
    color: #1e3a8a !important;
    font-weight: 700;
}
</style>

<!-- Script para Sistema de Pestañas -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Script de pestañas cargado');
    
    // Sistema de pestañas
    const tabs = document.querySelectorAll('.tab');
    console.log('Pestañas encontradas:', tabs.length);
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Click en pestaña:', this.getAttribute('data-tab'));
            
            // Remover active de todas las pestañas
            tabs.forEach(t => t.classList.remove('tab-active'));
            
            // Agregar active a la pestaña clickeada
            this.classList.add('tab-active');
            
            // Ocultar todos los contenidos
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // Mostrar el contenido seleccionado
            const tabId = this.getAttribute('data-tab');
            const selectedContent = document.getElementById(tabId);
            if (selectedContent) {
                selectedContent.style.display = 'block';
                console.log('Mostrando contenido:', tabId);
            }
        });
    });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Script de ApexCharts cargado');
    console.log('ApexCharts disponible:', typeof ApexCharts !== 'undefined');
    
    // ========== DATOS ==========
{% if clientes_con_reservas %}
const clientesData = [
    {% for item in clientes_con_reservas|slice:":10" %}
    {
        nombre: "{{ item.cliente.nombre|escapejs }} {{ item.cliente.apellido|escapejs }}",
        gasto: parseFloat("{{ item.total_gasto }}"),
        reservas: parseInt("{{ item.num_reservas }}")
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];
console.log('clientesData:', clientesData);
{% endif %}

{% if canchas_con_reservas %}
const canchasData = [
    {% for item in canchas_con_reservas %}
    {
        nombre: "{{ item.cancha.nombre|escapejs }}",
        ingresos: parseFloat("{{ item.total_ingresos }}"),
        horas: parseFloat("{{ item.total_horas }}"),
        reservas: parseInt("{{ item.num_reservas }}")
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];
console.log('canchasData:', canchasData);
{% endif %}

{% if meses_data %}
const mesesData = {{ meses_data_json|safe }};
const categorias = mesesData.map(m => `${m.mes} ${m.anio}`);
const reservasData = mesesData.map(m => m.total_reservas);
const horasData = mesesData.map(m => parseFloat(m.total_horas.toFixed(1)));
{% endif %}

// ========== GRÁFICO 1: TOP 10 CLIENTES (BARRAS HORIZONTALES) ==========
{% if clientes_con_reservas %}
const optionsTopClientes = {
    series: [{
        name: 'Gasto Total',
        data: clientesData.map(c => c.gasto)
    }],
    chart: {
        type: 'bar',
        height: 400,
        toolbar: { show: true }
    },
    colors: ['#84cc16'],
    plotOptions: {
        bar: {
            borderRadius: 6,
            horizontal: true,
            dataLabels: { position: 'right' }
        }
    },
    dataLabels: {
        enabled: true,
        formatter: function(val) {
            return '$' + val.toFixed(0);
        },
        style: {
            fontSize: '12px',
            fontWeight: 'bold',
            colors: ['#1e3a8a']
        }
    },
    xaxis: {
        categories: clientesData.map(c => c.nombre),
        labels: {
            formatter: function(val) {
                return '$' + val;
            }
        }
    },
    yaxis: {
        labels: {
            style: { fontSize: '11px' }
        }
    },
    title: {
        text: 'Top 10 Clientes por Gasto Total',
        align: 'center',
        style: { fontSize: '16px', fontWeight: 700, color: '#1e3a8a' }
    },
    tooltip: {
        y: {
            formatter: function(val) {
                return '$' + val.toFixed(2);
            }
        }
    }
};

var chartTopClientes = new ApexCharts(document.querySelector("#chartTopClientes"), optionsTopClientes);
console.log('chartTopClientes creado:', chartTopClientes);
console.log('Contenedor #chartTopClientes existe:', document.querySelector("#chartTopClientes") !== null);
{% endif %}

// ========== GRÁFICO 2: DISTRIBUCIÓN DE INGRESOS POR CANCHA (DONA) ==========
{% if canchas_con_reservas %}
const optionsDistribucion = {
    series: canchasData.map(c => c.ingresos),
    chart: {
        type: 'donut',
        height: 400
    },
    labels: canchasData.map(c => c.nombre),
    colors: ['#84cc16', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'],
    dataLabels: {
        enabled: true,
        formatter: function(val, opts) {
            return '$' + opts.w.config.series[opts.seriesIndex].toFixed(0);
        }
    },
    legend: {
        position: 'bottom',
        fontSize: '12px'
    },
    title: {
        text: 'Distribución de Ingresos por Cancha',
        align: 'center',
        style: { fontSize: '16px', fontWeight: 700, color: '#1e3a8a' }
    },
    tooltip: {
        y: {
            formatter: function(val) {
                return '$' + val.toFixed(2);
            }
        }
    },
    plotOptions: {
        pie: {
            donut: {
                size: '65%',
                labels: {
                    show: true,
                    total: {
                        show: true,
                        label: 'Total Ingresos',
                        formatter: function(w) {
                            return '$' + w.globals.seriesTotals.reduce((a, b) => a + b, 0).toFixed(0);
                        }
                    }
                }
            }
        }
    }
};

var chartDistribucion = new ApexCharts(document.querySelector("#chartDistribucionCanchas"), optionsDistribucion);
// No renderizar inmediatamente
{% endif %}

// ========== GRÁFICO 3: RANKING DE CANCHAS (BARRAS) ==========
{% if canchas_ranking %}
const optionsRanking = {
    series: [{
        name: 'Reservas',
        data: canchasData.slice(0, 10).map(c => c.reservas)
    }],
    chart: {
        type: 'bar',
        height: 400,
        toolbar: { show: true }
    },
    colors: ['#3b82f6'],
    plotOptions: {
        bar: {
            borderRadius: 8,
            columnWidth: '70%',
            dataLabels: { position: 'top' }
        }
    },
    dataLabels: {
        enabled: true,
        offsetY: -25,
        style: {
            fontSize: '14px',
            fontWeight: 'bold',
            colors: ['#1e3a8a']
        }
    },
    xaxis: {
        categories: canchasData.slice(0, 10).map(c => c.nombre),
        labels: {
            rotate: -45,
            style: { fontSize: '11px' }
        }
    },
    yaxis: {
        title: {
            text: 'Número de Reservas',
            style: { color: '#1e3a8a', fontSize: '14px', fontWeight: 700 }
        }
    },
    title: {
        text: 'Top 10 Canchas por Número de Reservas',
        align: 'center',
        style: { fontSize: '16px', fontWeight: 700, color: '#1e3a8a' }
    },
    grid: {
        borderColor: '#e2e8f0',
        strokeDashArray: 4
    }
};

var chartRanking = new ApexCharts(document.querySelector("#chartRankingCanchas"), optionsRanking);
// No renderizar inmediatamente
{% endif %}

// ========== GRÁFICO 4: RESERVAS MENSUALES (BARRAS) ==========
{% if meses_data %}
const optionsReservas = {
    series: [{
        name: 'Reservas',
        data: reservasData
    }],
    chart: {
        type: 'bar',
        height: 350,
        toolbar: { show: true }
    },
    colors: ['#84cc16'],
    plotOptions: {
        bar: {
            borderRadius: 8,
            columnWidth: '60%',
            dataLabels: {
                position: 'top'
            }
        }
    },
    dataLabels: {
        enabled: true,
        offsetY: -25,
        style: {
            fontSize: '14px',
            fontWeight: 'bold',
            colors: ['#1e3a8a']
        },
        formatter: function(val) {
            return val + ' reservas';
        }
    },
    xaxis: {
        categories: categorias,
        labels: {
            style: {
                colors: '#475569',
                fontSize: '12px',
                fontWeight: 600
            }
        },
        axisBorder: {
            show: true,
            color: '#cbd5e1'
        },
        axisTicks: {
            show: true,
            color: '#cbd5e1'
        }
    },
    yaxis: {
        title: {
            text: 'Cantidad de Reservas',
            style: {
                color: '#1e3a8a',
                fontSize: '14px',
                fontWeight: 700
            }
        },
        labels: {
            style: {
                colors: '#475569',
                fontSize: '12px'
            },
            formatter: function(val) {
                return Math.floor(val);
            }
        }
    },
    grid: {
        borderColor: '#e2e8f0',
        strokeDashArray: 4,
        xaxis: {
            lines: {
                show: false
            }
        },
        yaxis: {
            lines: {
                show: true
            }
        }
    },
    tooltip: {
        y: {
            formatter: function(val) {
                return val + ' reservas';
            }
        },
        theme: 'light',
        style: {
            fontSize: '13px'
        }
    },
    title: {
        text: 'Cantidad de Reservas por Mes',
        align: 'center',
        style: {
            fontSize: '18px',
            fontWeight: 700,
            color: '#1e3a8a'
        }
    }
};

var chartReservas = new ApexCharts(document.querySelector("#chartReservasMensuales"), optionsReservas);
// No renderizar inmediatamente

// GRÁFICO 2: Horas Utilizadas (Línea + Área)
const optionsHoras = {
    series: [{
        name: 'Horas',
        data: horasData
    }],
    chart: {
        type: 'area',
        height: 350,
        toolbar: {
            show: true,
            tools: {
                download: true,
                selection: false,
                zoom: false,
                zoomin: false,
                zoomout: false,
                pan: false,
                reset: false
            }
        },
        animations: {
            enabled: true,
            speed: 800
        }
    },
    colors: ['#3b82f6'],
    fill: {
        type: 'gradient',
        gradient: {
            shadeIntensity: 1,
            opacityFrom: 0.7,
            opacityTo: 0.2,
            stops: [0, 90, 100]
        }
    },
    dataLabels: {
        enabled: true,
        style: {
            fontSize: '12px',
            fontWeight: 'bold',
            colors: ['#1e3a8a']
        },
        background: {
            enabled: true,
            foreColor: '#fff',
            borderRadius: 4,
            padding: 6,
            opacity: 0.9,
            borderWidth: 0
        },
        formatter: function(val) {
            return val + 'h';
        }
    },
    stroke: {
        curve: 'smooth',
        width: 3
    },
    xaxis: {
        categories: categorias,
        labels: {
            style: {
                colors: '#475569',
                fontSize: '12px',
                fontWeight: 600
            }
        },
        axisBorder: {
            show: true,
            color: '#cbd5e1'
        }
    },
    yaxis: {
        title: {
            text: 'Horas Totales',
            style: {
                color: '#1e3a8a',
                fontSize: '14px',
                fontWeight: 700
            }
        },
        labels: {
            style: {
                colors: '#475569',
                fontSize: '12px'
            },
            formatter: function(val) {
                return val.toFixed(1) + 'h';
            }
        }
    },
    grid: {
        borderColor: '#e2e8f0',
        strokeDashArray: 4
    },
    markers: {
        size: 6,
        colors: ['#3b82f6'],
        strokeColors: '#fff',
        strokeWidth: 2,
        hover: {
            size: 8
        }
    },
    tooltip: {
        y: {
            formatter: function(val) {
                return val.toFixed(1) + ' horas';
            }
        },
        theme: 'light',
        style: {
            fontSize: '13px'
        }
    },
    title: {
        text: 'Total de Horas Utilizadas por Mes',
        align: 'center',
        style: {
            fontSize: '18px',
            fontWeight: 700,
            color: '#1e3a8a'
        }
    }
};

    var chartHoras = new ApexCharts(document.querySelector("#chartHorasMensuales"), optionsHoras);
    {% endif %}

    // ========== RENDERIZADO DE GRÁFICOS ==========
    // Renderizar el primer gráfico al cargar
    setTimeout(() => {
        {% if clientes_con_reservas %}
        if (typeof chartTopClientes !== 'undefined') {
            const container = document.querySelector("#chartTopClientes");
            console.log('Contenedor chartTopClientes:', container);
            console.log('Contenedor visible:', container && container.offsetParent !== null);
            console.log('Renderizando chartTopClientes');
            try {
                chartTopClientes.render();
                console.log('chartTopClientes renderizado exitosamente');
                window.chartTopClientesRendered = true;
            } catch (error) {
                console.error('Error renderizando chartTopClientes:', error);
            }
        } else {
            console.error('chartTopClientes no está definido');
        }
        {% endif %}
    }, 300);

    // Agregar listeners para renderizar gráficos cuando se cambie de pestaña
    document.addEventListener('click', function(e) {
        if (e.target.closest('.tab')) {
            const tab = e.target.closest('.tab');
            const tabId = tab.getAttribute('data-tab');
            
            setTimeout(() => {
                {% if clientes_con_reservas %}
                if (tabId === 'reporte1' && typeof chartTopClientes !== 'undefined' && !window.chartTopClientesRendered) {
                    console.log('Renderizando chartTopClientes en cambio de pestaña');
                    chartTopClientes.render();
                    window.chartTopClientesRendered = true;
                }
                {% endif %}
                {% if canchas_con_reservas %}
                if (tabId === 'reporte2' && typeof chartDistribucion !== 'undefined' && !window.chartDistribucionRendered) {
                    console.log('Renderizando chartDistribucion');
                    chartDistribucion.render();
                    window.chartDistribucionRendered = true;
                }
                if (tabId === 'reporte3' && typeof chartRanking !== 'undefined' && !window.chartRankingRendered) {
                    console.log('Renderizando chartRanking');
                    chartRanking.render();
                    window.chartRankingRendered = true;
                }
                {% endif %}
                {% if meses_data %}
                if (tabId === 'reporte4') {
                    if (typeof chartReservas !== 'undefined' && !window.chartReservasRendered) {
                        console.log('Renderizando chartReservas');
                        chartReservas.render();
                        window.chartReservasRendered = true;
                    }
                    if (typeof chartHoras !== 'undefined' && !window.chartHorasRendered) {
                        console.log('Renderizando chartHoras');
                        chartHoras.render();
                        window.chartHorasRendered = true;
                    }
                }
                {% endif %}
            }, 200);
        }
    });
});
</script>
{% endblock %}
